<!doctype html>
<html>
<head>
 <link rel="stylesheet" type="text/css" href="style.css">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/color-calendar@1.0.5/dist/css/theme-glass.css" />
    <title>Calendar Schedule</title>
</head>
<body>
  <div class="container">
    <div class="title"> 
        <h1>Driving Simulator Booking</h1>
    </div>
    <div class="row">
        <div>
            <div id="color-calendar"></div>
            <div class="legend-container">
                <div class="legend-header">Calendar legend</div>
                <div class="color-row">
                    <div>
                        <div class="avail-icon"></div>
                        Available
                    </div>
                    <div>
                        <div class="unavail-icon"></div>
                        Not available
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <h2 class="header">Available Time Slots</h2>
            <div class="sub-header" id="selected-date"></div>
            <div class="events-display"></div>
        </div>
    </div>
    <div class="row">
        <div class="selected-slots">
            <h2>Selected Time Slots</h2>
            <div class="selectedSlots"></div>
        </div>
    </div>
    <div class="row">
        <div class="cost"></div>
    </div>
    <div class="button-container" onClick="clickSubmitHandler()">
        <button class="submit-button">Submit</button>
    </div>

</div>
<script src="https://cdn.jsdelivr.net/npm/color-calendar@1.0.5/dist/bundle.min.js"></script>
<script src="script.js"></script>
<script>
    new Calendar({
        id: '#color-calendar',
        calendarSize: 'large',
        theme: 'glass',
        primaryColor: '#4F98DB',
        headerBackgroundColor: '#4F98DB',
        eventsData:[
        // correct slots:
        {
            start: '2022-09-12T06:00:00',
            end: '2022-09-12T20:30:00',
            slot: '10:30 AM - 11:30 AM',
            session: 'Session 3',
        },
        {
            start: '2022-09-12T06:00:00',
            end: '2022-09-12T20:30:00',
            slot: '12:30 PM - 1:30 PM',
            session: 'Session 5',
        },
        {
            start: '2022-09-12T06:00:00',
            end: '2022-09-12T20:30:00',
            slot: '4:30 PM - 5:30 PM',
            session: 'Session 9',
        },
        {
            start: '2022-09-19T06:00:00',
            end: '2022-09-19T20:30:00',
            slot: '10:30 AM - 11:30 AM',
            session: 'Session 3',
        },
        {
            start: '2022-09-19T06:00:00',
            end: '2022-09-19T20:30:00',
            slot: '12:30 PM - 1:30 PM',
            session: 'Session 5',
        },
        {
            start: '2022-09-19T06:00:00',
            end: '2022-09-19T20:30:00',
            slot: '4:30 PM - 5:30 PM',
            session: 'Session 9',
        },
        {
            start: '2022-09-26T06:00:00',
            end: '2022-09-26T20:30:00',
            slot: '10:30 AM - 11:30 AM',
            session: 'Session 3',
        },
        {
            start: '2022-09-26T06:00:00',
            end: '2022-09-26T20:30:00',
            slot: '12:30 PM - 1:30 PM',
            session: 'Session 5',
        },
        {
            start: '2022-09-26T06:00:00',
            end: '2022-09-26T20:30:00',
            slot: '4:30 PM - 5:30 PM',
            session: 'Session 9',
        },
        // incorrect slots:
        {
            start: '2022-04-12T06:00:00',
            end: '2022-04-12T20:30:00',
            slot: '8:30 AM - 9:30 AM',
            session: 'Session 1',
        },
        {
            start: '2022-04-12T06:00:00',
            end: '2022-04-12T20:30:00',
            slot: '12:30 PM - 1:30 PM',
            session: 'Session 5',
        },
        {
            start: '2022-04-13T06:00:00',
            end: '2022-04-13T20:30:00',
            slot: '3:30 PM - 4:30 PM',
            session: 'Session 8',
        },
        {
            start: '2022-04-13T06:00:00',
            end: '2022-04-13T20:30:00',
            slot: '4:30 PM - 5:30 PM',
            session: 'Session 9',
        },
        {
            start: '2022-04-13T06:00:00',
            end: '2022-04-13T20:30:00',
            slot: '5:30 PM - 6:30 PM',
            session: 'Session 10',
        },
        {
            start: '2022-04-13T06:00:00',
            end: '2022-04-13T20:30:00',
            slot: '6:30 PM - 7:30 PM',
            session: 'Session 11',
        },
        {
            start: '2022-04-15T06:00:00',
            end: '2022-04-15T20:30:00',
            slot: '8:30 AM - 9:30 AM',
            session: 'Session 1',
        },
        {
            start: '2022-04-16T06:00:00',
            end: '2022-04-16T20:30:00',
            slot: '8:30 AM - 9:30 AM',
            session: 'Session 1',
        },
        {
            start: '2022-04-16T06:00:00',
            end: '2022-04-16T20:30:00',
            slot: '9:30 AM - 10:30 AM',
            session: 'Session 2',
        },
        {
            start: '2022-04-16T06:00:00',
            end: '2022-04-16T20:30:00',
            slot: '11:30 AM - 12:30 PM',
            session: 'Session 4',
        },
        {
            start: '2022-04-16T06:00:00',
            end: '2022-04-16T20:30:00',
            slot: '12:30 PM - 1:30 PM',
            session: 'Session 5',
        },
        {
            start: '2022-04-16T06:00:00',
            end: '2022-04-16T20:30:00',
            slot: '1:30 PM - 2:30 PM',
            session: 'Session 6',
        },
        {
            start: '2022-04-16T06:00:00',
            end: '2022-04-16T20:30:00',
            slot: '2:30 PM - 3:30 PM',
            session: 'Session 7',
        },
        {
            start: '2022-04-16T06:00:00',
            end: '2022-04-16T20:30:00',
            slot: '7:30 PM - 8:30 PM',
            session: 'Session 12',
        },
        ],
        dateChanged: (currentDate, events) => {
                const events_display = document.querySelector('.events-display');
                const date = currentDate.toDateString();
                document.getElementById('selected-date').innerHTML = date;

                let events_html = '';                
                events.forEach(event => {
                    const sessionNum = event.session.substring("Session ".length);
                    const key = date + sessionNum;
        
                    selectedStatus = key in selectedSessions ? "selected" : "unselected";
                    events_html += `
                        <div id="available-timeslot" onclick="clickAvailTimeSlotHandler(this)" class="avail-timeslot ${selectedStatus}">
                            <p class="event-slot">${event.slot}</p>
                            <p>${event.session}<p>
                        </div>
                    `
                });

                if(events_html) {
                    events_display.innerHTML = events_html;
                } else {
                    events_display.innerHTML = '<div class="no-events-text">There are no more available slots. <br> Please select an available date that is marked in green.</div>';
                }
            },
        })

        if (document.querySelector(".selectedSlots").innerHTML.length == 0) {
            document.querySelector(".selectedSlots").innerHTML = `<p>Please select a timeslot above.</p>`
        }

        // Set task_id here
        sessionStorage.setItem('task_id', '14')

        let selectedSessions = {};

        function clickAvailTimeSlotHandler(element) {
            const currDate = document.getElementById('selected-date').innerHTML;
            const sessionNo = element.innerHTML.split("Session")[1].trim().charAt(0);
            // add selected timeslot html only if timeslot not found in dict
            const key = currDate + sessionNo;
            if (!(key in selectedSessions)) {
                // add selected timeslot
                element.className = "avail-timeslot selected";
                selectedSessions[key] = {
                    date: currDate,
                    slot: element.querySelector(".event-slot").innerHTML,
                    session: sessionNo,
                    innerHTML: element.innerHTML
                };

            } else {
                // remove selected timeslot
                element.className = "avail-timeslot unselected";
                delete selectedSessions[key];
            }

            // render all selected slots in dict
            let allSelectedSlotsHtml = '';
            for (const value of Object.values(selectedSessions)) {
                allSelectedSlotsHtml += `
                    <div class="selected-timeslot">
                        <b>${value.date}</b>
                        ${value.innerHTML}
                    </div>
                `
            }
            const numOfSelectedSlots = Object.values(selectedSessions).length;

            // display html
            document.querySelector(".selectedSlots").innerHTML = allSelectedSlotsHtml;
            document.querySelector(".cost").innerHTML = 
                `<p>Total cost: $20 x ` + numOfSelectedSlots 
                + ` = ` + 20 * numOfSelectedSlots;
        }

        function clickSubmitHandler() {
            console.log("submit clicked with selectedSessions: ", selectedSessions);

            // show popup alert if user submits without selecting any slots
            if (Object.values(selectedSessions).length == 0) {
                window.alert('Please select booking slot(s) before submission.')
            } else {
                // add to sessionstorage as string
                sessionStorage.setItem('selectedSessions', JSON.stringify(selectedSessions));
                sessionStorage.setItem('totalCost', 20 * Object.values(selectedSessions).length);

                checkSelection();
            }
        }
</script>
</body>
</html>